<!doctype html>
<html>
<head>
  <!-- A-Frame compatível com AR.js -->
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.5/aframe/build/aframe-ar.js"></script>
  <style>
    body { margin:0; overflow:hidden; font-family:sans-serif; }
    #startUI { position:fixed; inset:0; display:flex; flex-direction:column;
      align-items:center; justify-content:center; background:#000; color:#fff; gap:16px; z-index:10; }
    #startUI button { padding:12px 24px; font-size:16px; cursor:pointer; }
    #status { position:fixed; top:8px; left:8px; background:rgba(0,0,0,.4); color:#fff;
      padding:4px 8px; font-size:12px; z-index:9; }
  </style>
</head>
<body>
  <div id="startUI">
    <h2>Teste de Tiro AR (AR.js + pattern)</h2>
    <p>Mostre o marcador .patt para a câmera.</p>
    <button id="startBtn">Iniciar</button>
    <small>Debug: use ?debug=1 para ver alvos sem marcador.</small>
  </div>
  <div id="status">Parado</div>

  <a-scene
    embedded
    renderer="colorManagement: true, physicallyCorrectLights: false"
    vr-mode-ui="enabled: false"
    arjs="sourceType: webcam; debugUIEnabled: false;"
  >
    <!-- Câmera + arma + mira -->
    <a-entity camera look-controls="enabled: false">
      <a-ring position="0 0 -0.5" radius-inner="0.006" radius-outer="0.014" color="#FF0000"></a-ring>
      <a-entity id="gun" position="0.40 -0.40 -0.7">
        <a-box position="0 0 0" width="0.10" height="0.10" depth="0.55" color="#222"></a-box>
        <a-box position="0 0 -0.28" width="0.06" height="0.26" depth="0.08" color="#111"></a-box>
      </a-entity>
    </a-entity>

    <!-- Marcador AR.js (.patt) -->
    <a-marker id="markerRoot" type="pattern" url="pattern-Imagem Alvo.patt">
      <a-entity id="targetsGroup"></a-entity>
      <a-text id="score" value="Pontos: 0" position="0 1.2 0" align="center" color="#FFF" width="2"></a-text>
    </a-marker>

    <!-- Grupo para debug sem marcador -->
    <a-entity id="debugGroup" visible="false" position="0 0 -2"></a-entity>

    <a-entity id="shoot-system"></a-entity>
  </a-scene>

  <script>
    let score = 0;
    let canShoot = true;
    let started = false;
    const debugMode = /[?&]debug=1/.test(location.search);

    function createTargets(parent){
      parent.innerHTML = '';
      const positions = [-1, 0, 1];
      const colors = ['#FF0000','#00FF00','#0000FF'];
      positions.forEach((x,i)=>{
        const el = document.createElement('a-sphere');
        el.classList.add('target');
        el.setAttribute('position', `${x} 0.5 0`);
        el.setAttribute('radius','0.3');
        el.setAttribute('color', colors[i]);
        el.setAttribute('animation', 'property: rotation; to: 0 360 0; loop: true; dur: 3000');
        parent.appendChild(el);
      });
      score = 0;
      document.querySelector('#score').setAttribute('value','Pontos: 0');
    }

    AFRAME.registerComponent('shoot-system', {
      init: function() {
        window.addEventListener('click', () => this.shoot());
        window.addEventListener('touchstart', (e) => { e.preventDefault(); this.shoot(); });

        // Eventos do marcador em AR.js
        const marker = document.getElementById('markerRoot');
        marker.addEventListener('markerFound', ()=>{
          if (!debugMode) createTargets(document.querySelector('#targetsGroup'));
          document.getElementById('status').textContent='Marcador detectado';
        });
        marker.addEventListener('markerLost', ()=>{
          if (!debugMode) document.getElementById('status').textContent='Marcador perdido';
        });
      },

      shoot: function() {
        if (!started || !canShoot) return;
        canShoot = false;
        setTimeout(()=>canShoot = true, 300);

        const gun = document.querySelector('#gun');
        gun.setAttribute('animation__recoil','property: position; to: 0.40 -0.40 -0.6; dur: 80; dir: alternate; easing: easeOutQuad');

        const camera = document.querySelector('[camera]');
        const raycaster = new THREE.Raycaster();
        const dir = new THREE.Vector3(0,0,-1);
        camera.object3D.getWorldDirection(dir);
        raycaster.set(camera.object3D.position.clone(), dir);

        document.querySelectorAll('.target').forEach(t=>{
          const intersects = raycaster.intersectObject(t.object3D, true);
          if (intersects.length>0) this.hitTarget(t);
        });
      },

      hitTarget: function(target){
        score += 10;
        const scoreEl = document.querySelector('#score');
        scoreEl.setAttribute('value', `Pontos: ${score}`);
        target.setAttribute('animation__hit','property: scale; to: 0.1 0.1 0.1; dur: 180; easing: easeInQuad');
        setTimeout(()=>{
          target.parentNode && target.parentNode.removeChild(target);
          if (document.querySelectorAll('.target').length===0){
            scoreEl.setAttribute('value', `VITÓRIA! Pontos: ${score}`);
          }
        },190);
      }
    });

    document.querySelector('#shoot-system').setAttribute('shoot-system','');

    // UI iniciar (só esconde overlay)
    document.getElementById('startBtn').addEventListener('click', ()=>{
      started = true;
      document.getElementById('startUI').style.display='none';
      document.getElementById('status').textContent = debugMode ? 'Debug sem marcador' : 'Buscando marcador...';

      if (debugMode){
        document.getElementById('debugGroup').setAttribute('visible','true');
        createTargets(document.getElementById('debugGroup'));
      }
    });
  </script>
</body>
</html>